# OPS-140: Upgrade GitHub Actions to v3 (2023-10)
# Modern CI Pipeline
# This pipeline uses current best practices and updated action versions

name: CI

on:
  push:
    branches: [main, feature/*]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ENABLE_V1_API: "true"
  TF_VERSION: "1.5.0"
  HELM_VERSION: "3.13.0"

jobs:
  lint-terraform:
    name: Lint Terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/

      - name: Terraform Validate (Staging)
        run: |
          cd terraform/environments/staging
          terraform init -backend=false
          terraform validate

      - name: Terraform Validate (Prod)
        run: |
          cd terraform/environments/prod
          terraform init -backend=false
          terraform validate

  lint-helm:
    name: Lint Helm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Lint Helm Chart
        run: helm lint ./helm/acme-shop

      - name: Template with Modern Values
        run: |
          helm template acme-shop ./helm/acme-shop \
            -f ./helm/acme-shop/values.yaml \
            --namespace tm-acme-shop

      # TODO(TEAM-INFRA): Add helm diff comparison
      - name: Template with Legacy Values
        run: |
          helm template acme-shop ./helm/acme-shop \
            -f ./helm/acme-shop/values-legacy.yaml \
            --namespace tm-acme-shop

  lint-kubernetes:
    name: Lint Kubernetes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Validate Base Manifests
        run: |
          kubectl apply --dry-run=client -f kubernetes/base/ 2>&1 || true

      - name: Validate Staging Overlay
        run: |
          kubectl apply --dry-run=client -k kubernetes/overlays/staging/ 2>&1 || true

      - name: Validate Prod Overlay
        run: |
          kubectl apply --dry-run=client -k kubernetes/overlays/prod/ 2>&1 || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy on Terraform
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: terraform/
          exit-code: "0"
          severity: CRITICAL,HIGH

      - name: Run Trivy on Kubernetes
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: kubernetes/
          exit-code: "0"
          severity: CRITICAL,HIGH

      - name: Run Trivy on Helm
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: helm/
          exit-code: "0"
          severity: CRITICAL,HIGH

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint-terraform, lint-helm, lint-kubernetes, security-scan]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Package Helm Chart
        run: |
          helm package ./helm/acme-shop --version 1.0.0

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: acme-shop-1.0.0.tgz
          retention-days: 30
