# Legacy CI Pipeline
# TODO(TEAM-OPS): Migrate to ci-modern.yml - this pipeline uses outdated action versions
# This file is kept for Batch Changes demo (upgrading action versions)

name: CI (Legacy)

on:
  push:
    branches: [main, legacy]
  pull_request:
    branches: [main]

# TODO(TEAM-SEC): Add CODEOWNERS approval requirement
# TODO(TEAM-OPS): Add concurrency controls

env:
  ENABLE_LEGACY_AUTH: "true"
  ENABLE_V1_API: "true"
  ENABLE_LEGACY_PAYMENTS: "true"
  TF_VERSION: "1.0.0"

jobs:
  lint-terraform:
    name: Lint Terraform
    runs-on: ubuntu-latest
    steps:
      # TODO(TEAM-OPS): Upgrade to actions/checkout@v4
      - uses: actions/checkout@v1

      - name: Setup Terraform
        # TODO(TEAM-OPS): Upgrade to hashicorp/setup-terraform@v3
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/

      - name: Terraform Validate
        run: |
          cd terraform/environments/staging
          terraform init -backend=false
          terraform validate

  lint-helm:
    name: Lint Helm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      # TODO(TEAM-OPS): Upgrade to azure/setup-helm@v4
      - name: Setup Helm
        uses: azure/setup-helm@v1
        with:
          version: "3.10.0"

      - name: Lint Helm Chart
        run: helm lint ./helm/acme-shop

      - name: Template Helm Chart
        run: |
          helm template acme-shop ./helm/acme-shop \
            -f ./helm/acme-shop/values.yaml \
            --namespace tm-acme-shop

  lint-kubernetes:
    name: Lint Kubernetes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      # TODO(TEAM-OPS): Upgrade to actions/setup-node@v4
      - uses: actions/setup-node@v1
        with:
          node-version: "16"

      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          kubeval --strict kubernetes/base/*.yaml || true

  security-scan-legacy:
    name: Security Scan (Basic)
    runs-on: ubuntu-latest
    # TODO(TEAM-SEC): This scan is too permissive, use security-scan.yml instead
    steps:
      - uses: actions/checkout@v1

      - name: Run basic security checks
        run: |
          echo "Checking for hardcoded secrets..."
          # TODO(TEAM-SEC): Replace with proper secret scanning
          grep -r "password\s*=" . --include="*.tf" || true
          grep -r "api_key\s*=" . --include="*.yaml" || true

      - name: Check for open security groups
        run: |
          echo "Checking for 0.0.0.0/0 CIDR blocks..."
          grep -r "0.0.0.0/0" terraform/ || echo "No open CIDR blocks found"

  build-legacy:
    name: Build (Legacy)
    runs-on: ubuntu-latest
    needs: [lint-terraform, lint-helm, lint-kubernetes]
    steps:
      - uses: actions/checkout@v1

      - name: Setup environment
        run: |
          echo "ENABLE_LEGACY_AUTH=${ENABLE_LEGACY_AUTH}"
          echo "ENABLE_V1_API=${ENABLE_V1_API}"
          echo "ENABLE_LEGACY_PAYMENTS=${ENABLE_LEGACY_PAYMENTS}"

      - name: Package Helm Chart
        run: |
          helm package ./helm/acme-shop --version 0.1.0-legacy

      - name: Archive artifacts
        # TODO(TEAM-OPS): Upgrade to actions/upload-artifact@v4
        uses: actions/upload-artifact@v1
        with:
          name: helm-chart-legacy
          path: acme-shop-0.1.0-legacy.tgz
